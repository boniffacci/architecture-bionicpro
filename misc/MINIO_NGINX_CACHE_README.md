# –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á—ë—Ç–æ–≤ —á–µ—Ä–µ–∑ nginx reverse proxy –ø–µ—Ä–µ–¥ MinIO

## –û–±—â–∏–π –∑–∞–º—ã—Å–µ–ª

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á—ë—Ç–æ–≤, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å–∫–∞—á–∏–≤–∞—Ç—å –æ—Ç—á—ë—Ç—ã –Ω–∞–ø—Ä—è–º—É—é –∏–∑ MinIO —á–µ—Ä–µ–∑ nginx reverse proxy —Å JWT-–≤–∞–ª–∏–¥–∞—Ü–∏–µ–π, –Ω–µ –Ω–∞–≥—Ä—É–∂–∞—è reports_api. 

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:

1. **–°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ reports_api**: –æ—Ç—á—ë—Ç—ã —Å–∫–∞—á–∏–≤–∞—é—Ç—Å—è –∏–∑ MinIO, –∞ –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –∑–∞–Ω–æ–≤–æ
2. **–ë—ã—Å—Ç—Ä–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞**: nginx —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç —Ñ–∞–π–ª—ã –±–µ–∑ –∑–∞–≥—Ä—É–∑–∫–∏ –≤ –ø–∞–º—è—Ç—å
3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: JWT-–≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ nginx —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: nginx –º–æ–∂–µ—Ç –±—ã—Ç—å –ª–µ–≥–∫–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
–§—Ä–æ–Ω—Ç–µ–Ω–¥ --> Auth Proxy --> Nginx Reverse Proxy --> MinIO
                                   |
                                   v
                            JWT-–≤–∞–ª–∏–¥–∞—Ü–∏—è
                            –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
```

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### 1. Nginx Reverse Proxy (OpenResty)

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ**: `minio_nginx/`

**–§–∞–π–ª—ã**:
- `nginx.conf` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è nginx —Å Lua-—Å–∫—Ä–∏–ø—Ç–∞–º–∏ –¥–ª—è JWT-–≤–∞–ª–∏–¥–∞—Ü–∏–∏
- `Dockerfile` - –æ–±—Ä–∞–∑ –Ω–∞ –±–∞–∑–µ OpenResty (nginx + Lua)

**–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å**:
- –ü—Ä–∏–Ω–∏–º–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É 9002 (—Ö–æ—Å—Ç) / 9001 (–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä)
- –†–∞–∑—Ä–µ—à–∞–µ—Ç —Ç–æ–ª—å–∫–æ GET/HEAD –∑–∞–ø—Ä–æ—Å—ã –∫ `/reports/*`
- –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç JWT-—Ç–æ–∫–µ–Ω –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ `Authorization`
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞:
  - **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã** (`administrators`): –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ñ–∞–π–ª–∞–º
  - **–û–±—ã—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏** (`prosthetic_users`): –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –∫ —Å–≤–æ–∏–º —Ñ–∞–π–ª–∞–º
- –ü—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∫ MinIO –±–µ–∑ –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏ (—Å—Ç—Ä–∏–º–∏–Ω–≥ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤)

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞**:
```lua
-- –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É: /reports/{schema}/{user_uuid}/{filename}
-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª, –µ—Å–ª–∏:
-- 1. –û–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä (—Ä–æ–ª—å "administrators")
-- 2. –ò–ª–∏ {user_uuid} —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –µ–≥–æ sub –∏–ª–∏ external_uuid –∏–∑ JWT
```

#### 2. –§—Ä–æ–Ω—Ç–µ–Ω–¥ (App.tsx)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:

1. **–§—É–Ω–∫—Ü–∏—è `buildReportFileName`**: —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –∏–º—è —Ñ–∞–π–ª–∞ –æ—Ç—á—ë—Ç–∞ –≤ MinIO –ø–æ —Ç–µ–º –∂–µ –ø—Ä–∞–≤–∏–ª–∞–º, —á—Ç–æ –∏ reports_api
   ```typescript
   const fileName = buildReportFileName(schema, targetUserUuid, null, end_ts)
   // –†–µ–∑—É–ª—å—Ç–∞—Ç: "default/54885c9b-6eea-48f7-89f9-353ad8273e95/none__2025-11-01T00-00-00.json"
   ```

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞ –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π**:
   ```typescript
   // –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è —Å–∫–∞—á–∞—Ç—å –∏–∑ MinIO —á–µ—Ä–µ–∑ nginx
   const minioUrl = `http://minio-nginx:9001/${fileName}`
   const minioResponse = await fetch(`${AUTH_PROXY_URL}/proxy`, {
     method: 'POST',
     body: JSON.stringify({
       upstream_uri: minioUrl,
       method: 'GET',
       redirect_to_sign_in: false
     })
   })
   
   if (minioResponse.ok) {
     // –û—Ç—á—ë—Ç –Ω–∞–π–¥–µ–Ω –≤ –∫—ç—à–µ
     const cachedReport = await minioResponse.json()
     cachedReport.from_cache = true
     setReportResponse(cachedReport)
     return
   }
   
   // –û—Ç—á—ë—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π —á–µ—Ä–µ–∑ reports_api
   ```

3. **–ü–æ–ª–µ `from_cache`**: —Ç–µ–ø–µ—Ä—å —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ, –∞ –Ω–µ –≤ reports_api

#### 3. Reports API

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:

1. **–£–¥–∞–ª–µ–Ω–æ –ø–æ–ª–µ `from_cache`** –∏–∑ –º–æ–¥–µ–ª–∏ `ReportResponse`
2. **–£–¥–∞–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞** –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `generate_report_data`:
   - –ú–µ—Ç–æ–¥ `/reports` –≤—Å–µ–≥–¥–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–π –æ—Ç—á—ë—Ç
   - –û—Ç—á—ë—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ MinIO —Å –ø–µ—Ä–µ–∑–∞–ø–∏—Å—å—é —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ñ–∞–π–ª–∞
   - –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Ñ–∞–π–ª–æ–≤: 92 –¥–Ω—è (–Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ —á–µ—Ä–µ–∑ lifecycle policy)

3. **–û–±–Ω–æ–≤–ª–µ–Ω—ã —Ç–µ—Å—Ç—ã**:
   - –£–¥–∞–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–ª—è `from_cache`
   - –¢–µ—Å—Ç—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç, —á—Ç–æ —Ñ–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ MinIO
   - –¢–µ—Å—Ç—ã –Ω–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (—ç—Ç–æ –¥–µ–ª–∞–µ—Ç —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥)

#### 4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

**–ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è `test_flow_for_one_user`**:

–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è flow –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:
- `username`, `password` - —É—á—ë—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- `expected_user_uuid`, `expected_email`, `expected_name` - –æ–∂–∏–¥–∞–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ
- `try_other_users` - –ø—ã—Ç–∞—Ç—å—Å—è –ª–∏ —Å–∫–∞—á–∞—Ç—å —á—É–∂–∏–µ –æ—Ç—á—ë—Ç—ã
- `other_user_uuids` - —Å–ø–∏—Å–æ–∫ UUID –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- `should_fail_for_other_users` - –¥–æ–ª–∂–Ω–∞ –ª–∏ –±—ã—Ç—å –æ—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞
- `schema` - —Å—Ö–µ–º–∞ –æ—Ç—á—ë—Ç–æ–≤ ('default' –∏–ª–∏ 'debezium')

**–°—Ü–µ–Ω–∞—Ä–∏–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è**:

1. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–∞ (–ø–µ—Ä–≤—ã–π —Ä–∞–∑)**:
   - –û—Ç—á—ë—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ reports_api
   - –§—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "üîÑ –ù–µ –∏–∑ –∫—ç—à–∞"

2. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–≥–æ –∂–µ –æ—Ç—á—ë—Ç–∞ (–≤—Ç–æ—Ä–æ–π —Ä–∞–∑)**:
   - –û—Ç—á—ë—Ç —Å–∫–∞—á–∏–≤–∞–µ—Ç—Å—è –∏–∑ MinIO —á–µ—Ä–µ–∑ nginx
   - –§—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "üì¶ –ò–∑ –∫—ç—à–∞"

3. **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–∫–∞—á–∏–≤–∞–µ—Ç —á—É–∂–æ–π –æ—Ç—á—ë—Ç**:
   - –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≤–≤–æ–¥–∏—Ç –∫–∞—Å—Ç–æ–º–Ω—ã–π UUID
   - –û—Ç—á—ë—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è/—Å–∫–∞—á–∏–≤–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ
   - –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ –æ—Ç—á—ë—Ç –±–µ—Ä—ë—Ç—Å—è –∏–∑ –∫—ç—à–∞

4. **–û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—ã—Ç–∞–µ—Ç—Å—è —Å–∫–∞—á–∞—Ç—å —á—É–∂–æ–π –æ—Ç—á—ë—Ç**:
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –∫–∞—Å—Ç–æ–º–Ω—ã–π UUID
   - –ü–æ–ª—É—á–∞–µ—Ç –æ—à–∏–±–∫—É 403 (Access denied)

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤ –≤ MinIO

```
reports/
‚îú‚îÄ‚îÄ default/
‚îÇ   ‚îú‚îÄ‚îÄ {user_uuid_1}/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ none__2025-11-01T00-00-00.json
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 2025-01-01T00-00-00__2025-02-01T00-00-00.json
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ all_time.json
‚îÇ   ‚îî‚îÄ‚îÄ {user_uuid_2}/
‚îÇ       ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ debezium/
    ‚îú‚îÄ‚îÄ {user_uuid_1}/
    ‚îÇ   ‚îî‚îÄ‚îÄ ...
    ‚îî‚îÄ‚îÄ {user_uuid_2}/
        ‚îî‚îÄ‚îÄ ...
```

## –ó–∞–ø—É—Å–∫ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã

```bash
# –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–≤–∫–ª—é—á–∞—è –Ω–æ–≤—ã–π minio-nginx)
docker compose build

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∏—Å—Ç–µ–º—É
docker compose up -d

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ nginx –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
docker compose ps minio-nginx
docker compose logs minio-nginx
```

### 2. –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ reports_api

```bash
# –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
source .venv/bin/activate

# –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã
cd reports_api
pytest test_reports_with_jwt.py -v
```

### 3. –ó–∞–ø—É—Å–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤

```bash
# –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
cd tests
pytest test_integration.py::test_frontend_comprehensive_flow -v -s
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã nginx

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª—É (—Å JWT)

```bash
# –ü–æ–ª—É—á–∞–µ–º JWT-—Ç–æ–∫–µ–Ω (—á–µ—Ä–µ–∑ auth_proxy)
TOKEN=$(curl -s -X POST http://localhost:3000/sign_in \
  -H "Content-Type: application/json" \
  -d '{"username": "prosthetic1", "password": "prosthetic123"}' \
  | jq -r '.access_token')

# –°–∫–∞—á–∏–≤–∞–µ–º –æ—Ç—á—ë—Ç —á–µ—Ä–µ–∑ nginx (—á–µ—Ä–µ–∑ auth_proxy)
curl -X POST http://localhost:3000/proxy \
  -H "Content-Type: application/json" \
  -H "Cookie: session_id=..." \
  -d '{
    "upstream_uri": "http://minio-nginx:9001/reports/default/54885c9b-6eea-48f7-89f9-353ad8273e95/none__2025-11-01T00-00-00.json",
    "method": "GET",
    "redirect_to_sign_in": false
  }'
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∫–∞–∑–∞ –≤ –¥–æ—Å—Ç—É–ø–µ (—á—É–∂–æ–π —Ñ–∞–π–ª)

```bash
# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å prosthetic2 –ø—ã—Ç–∞–µ—Ç—Å—è —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª prosthetic1
# –î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—à–∏–±–∫–∞ 403
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### JWT-–≤–∞–ª–∏–¥–∞—Ü–∏—è

Nginx –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:
1. **–ù–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞**: –∑–∞–≥–æ–ª–æ–≤–æ–∫ `Authorization: Bearer <token>`
2. **–§–æ—Ä–º–∞—Ç —Ç–æ–∫–µ–Ω–∞**: –≤–∞–ª–∏–¥–Ω—ã–π JWT (header.payload.signature)
3. **–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è**: –ø–æ–ª–µ `exp` –Ω–µ –∏—Å—Ç–µ–∫–ª–æ
4. **–†–æ–ª–∏**: –ø–æ–ª–µ `realm_roles` –∏–ª–∏ `realm_access.roles`
5. **UUID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**: –ø–æ–ª–µ `external_uuid` –∏–ª–∏ `sub`

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞

```lua
-- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
if is_admin then
    -- –î–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ñ–∞–π–ª–∞–º
    ngx.log(ngx.INFO, "Admin access granted")
else
    -- –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    if file_user_uuid ~= user_uuid then
        ngx.status = 403
        ngx.say('{"error": "Access denied: you can only access your own reports"}')
        return ngx.exit(403)
    end
end
```

### –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏

```nginx
# –û—Ç–∫–ª—é—á–∞–µ–º –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—é –¥–ª—è —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
proxy_buffering off;
proxy_request_buffering off;
```

–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç nginx –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã –ª—é–±–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –±–µ–∑ –∑–∞–≥—Ä—É–∑–∫–∏ –≤ –ø–∞–º—è—Ç—å.

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –æ—Ç–ª–∞–¥–∫–∞

### –õ–æ–≥–∏ nginx

```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ nginx
docker compose logs -f minio-nginx

# –õ–æ–≥–∏ –¥–æ—Å—Ç—É–ø–∞
docker exec minio-nginx tail -f /var/log/nginx/access.log

# –õ–æ–≥–∏ –æ—à–∏–±–æ–∫
docker exec minio-nginx tail -f /var/log/nginx/error.log
```

### –ú–µ—Ç—Ä–∏–∫–∏

Nginx –ª–æ–≥–∏—Ä—É–µ—Ç –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π:
- –í—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞
- –ú–µ—Ç–æ–¥ –∏ URI
- –°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
- –†–∞–∑–º–µ—Ä –æ—Ç–≤–µ—Ç–∞
- User-Agent
- –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### 1. Nginx –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

**–ü—Ä–æ–±–ª–µ–º–∞**: –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ –æ–±—Ä–∞–∑–∞ OpenResty

**–†–µ—à–µ–Ω–∏–µ**:
```bash
# –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑
docker compose build minio-nginx --no-cache

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏
docker compose logs minio-nginx
```

### 2. JWT –Ω–µ –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è

**–ü—Ä–æ–±–ª–µ–º–∞**: –æ—à–∏–±–∫–∞ 401 –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª

**–†–µ—à–µ–Ω–∏–µ**:
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ JWT –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ `Authorization`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ä–º–∞—Ç: `Bearer <token>`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —Ç–æ–∫–µ–Ω–∞ (–ø–æ–ª–µ `exp`)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ nginx –¥–ª—è –¥–µ—Ç–∞–ª–µ–π

### 3. –û—à–∏–±–∫–∞ 403 (Access denied)

**–ü—Ä–æ–±–ª–µ–º–∞**: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç —Å–∫–∞—á–∞—Ç—å —Å–≤–æ–π —Ñ–∞–π–ª

**–†–µ—à–µ–Ω–∏–µ**:
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ UUID –≤ –ø—É—Ç–∏ —Ñ–∞–π–ª–∞ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å `sub` –∏–ª–∏ `external_uuid` –∏–∑ JWT
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–º–µ–µ—Ç —Ä–æ–ª—å `prosthetic_users` –∏–ª–∏ `administrators`
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ nginx –¥–ª—è –¥–µ—Ç–∞–ª–µ–π

### 4. –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω (404)

**–ü—Ä–æ–±–ª–µ–º–∞**: –æ—Ç—á—ë—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ MinIO

**–†–µ—à–µ–Ω–∏–µ**:
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –æ—Ç—á—ë—Ç –±—ã–ª —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ reports_api
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–º—è —Ñ–∞–π–ª–∞ (–¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —Ñ–æ—Ä–º–∞—Ç–æ–º –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –±–∞–∫–µ—Ç–∞ `reports` –≤ MinIO

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä—è–º—ã–º –¥–æ—Å—Ç—É–ø–æ–º –∫ reports_api

| –ú–µ—Ç—Ä–∏–∫–∞ | reports_api (–±–µ–∑ –∫—ç—à–∞) | nginx + MinIO (–∫—ç—à) |
|---------|------------------------|---------------------|
| –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ | ~500-1000 –º—Å | ~50-100 –º—Å |
| –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ CPU | –í—ã—Å–æ–∫–∞—è (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è) | –ù–∏–∑–∫–∞—è (–ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ) |
| –ù–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ –ë–î | –í—ã—Å–æ–∫–∞—è (–∑–∞–ø—Ä–æ—Å—ã –∫ ClickHouse) | –ù—É–ª–µ–≤–∞—è |
| –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å | –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∞ | –í—ã—Å–æ–∫–∞—è |

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

1. **–£–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ worker-–ø—Ä–æ—Ü–µ—Å—Å–æ–≤ nginx**:
   ```nginx
   worker_processes auto;  # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ CPU
   ```

2. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ nginx** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
   ```nginx
   proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=reports_cache:10m max_size=1g;
   proxy_cache reports_cache;
   proxy_cache_valid 200 1h;
   ```

3. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å CDN** –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è (production):
   - CloudFlare
   - AWS CloudFront
   - Google Cloud CDN

## –î–∞–ª—å–Ω–µ–π—à–µ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ JWT

–°–µ–π—á–∞—Å nginx –¥–µ–∫–æ–¥–∏—Ä—É–µ—Ç JWT –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏. –î–ª—è production –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —á–µ—Ä–µ–∑ JWKS –æ—Ç Keycloak:

```lua
local jwt = require "resty.jwt"
local validators = require "resty.jwt-validators"

-- –ü–æ–ª—É—á–∞–µ–º JWKS –æ—Ç Keycloak
local jwks_uri = "http://keycloak:8080/realms/reports-realm/protocol/openid-connect/certs"

-- –í–∞–ª–∏–¥–∏—Ä—É–µ–º JWT
local jwt_obj = jwt:verify(jwks, token, {
    exp = validators.is_not_expired(),
    iss = validators.equals("http://localhost:8080/realms/reports-realm")
})
```

### 2. Rate limiting

–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

```nginx
limit_req_zone $binary_remote_addr zone=reports_limit:10m rate=10r/s;

location /reports/ {
    limit_req zone=reports_limit burst=20;
    # ...
}
```

### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç—ã

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Prometheus –∏ Grafana –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤
- –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞
- –û—à–∏–±–∫–∏ (4xx, 5xx)
- –†–∞–∑–º–µ—Ä —Ç—Ä–∞—Ñ–∏–∫–∞

### 4. –°–∂–∞—Ç–∏–µ –æ—Ç–≤–µ—Ç–æ–≤

–í–∫–ª—é—á–µ–Ω–∏–µ gzip-—Å–∂–∞—Ç–∏—è –¥–ª—è JSON-—Ñ–∞–π–ª–æ–≤:

```nginx
gzip on;
gzip_types application/json;
gzip_min_length 1000;
```

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç—á—ë—Ç–æ–≤ —á–µ—Ä–µ–∑ nginx reverse proxy –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:
- ‚úÖ –í—ã—Å–æ–∫—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (JWT-–≤–∞–ª–∏–¥–∞—Ü–∏—è + –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤)
- ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å
- ‚úÖ –ü—Ä–æ—Å—Ç–æ—Ç—É –ø–æ–¥–¥–µ—Ä–∂–∫–∏

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –ª–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∞ –¥–ª—è production-–æ–∫—Ä—É–∂–µ–Ω–∏—è.

services:
  keycloak_db:
    container_name: keycloak_db
    image: postgres:14
    environment:
      POSTGRES_DB: keycloak_db
      POSTGRES_USER: keycloak_user
      POSTGRES_PASSWORD: keycloak_password
#    volumes:
#      - ./postgres-keycloak-data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
  keycloak:
    container_name: keycloak
    image: quay.io/keycloak/keycloak:26.4
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://keycloak_db:5432/keycloak_db
      KC_DB_USERNAME: keycloak_user
      KC_DB_PASSWORD: keycloak_password
    command: 
      - start-dev
      - --import-realm
    volumes:
      - ./keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD-SHELL", "timeout 3 bash -c 'exec 3<>/dev/tcp/localhost/8080'" ]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 20s
    depends_on:
      - keycloak_db
  openldap_zambia:
    container_name: openldap_zambia
    image: osixia/openldap:1.5.0
    environment:
      LDAP_ORGANISATION: "Zambia Company"
      LDAP_DOMAIN: "zambia.local"
      LDAP_ADMIN_PASSWORD: "admin123"
      LDAP_TLS: "false"
      LDAP_SEED_INTERNAL_LDIF_PATH: "/seed-ldif"
    volumes:
#      - ./ldap/data:/var/lib/ldap
#      - ./ldap/config:/etc/ldap/slapd.d
      - ./ldap:/seed-ldif
    ports:
      - "389:389"
  phpldapadmin:
    container_name: phpldapadmin
    image: osixia/phpldapadmin:latest
    environment:
      PHPLDAPADMIN_LDAP_HOSTS: openldap_zambia
      PHPLDAPADMIN_HTTPS: "false"
    ports:
      - "8081:80"
    depends_on:
      - openldap_zambia
  redis:
    # Redis для хранения сессий auth_proxy
    container_name: redis
    image: redis:7-alpine
    ports:
      - "6379:6379"  # Порт Redis
    command: redis-server --appendonly yes  # Включаем persistence
    # volumes:
    #   - ./redis-data:/data  # Персистентное хранилище (раскомментировать при необходимости)
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]  # Проверка здоровья Redis
      interval: 5s
      timeout: 3s
      retries: 5
#  frontend:
#    build:
#      context: ./frontend
#      dockerfile: Dockerfile
#    ports:
#      - "3000:3000"
#    environment:
#      REACT_APP_API_URL: http://localhost:8000
#      REACT_APP_KEYCLOAK_URL: http://localhost:8080
#      REACT_APP_KEYCLOAK_REALM: reports-realm
#      REACT_APP_KEYCLOAK_CLIENT_ID: reports-frontend

  crm_db:
    # PostgreSQL для CRM-системы и интернет-магазина (с поддержкой репликации для Debezium)
    container_name: crm_db
    image: postgres:14
    environment:
      POSTGRES_DB: crm_db  # Имя базы данных
      POSTGRES_USER: crm_user  # Пользователь БД
      POSTGRES_PASSWORD: crm_password  # Пароль пользователя
    command:
      - "postgres"
      - "-c"
      - "wal_level=logical"  # Включаем логическую репликацию для Debezium
#    volumes:
#        - ./postgres-crm-data:/var/lib/postgresql/data  # Персистентное хранилище данных
    ports:
      - "5444:5432"  # Порт для подключения к CRM DB
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U crm_user -d crm_db"]  # Проверка готовности PostgreSQL
      interval: 5s
      timeout: 3s
      retries: 5
  
  telemetry_db:
    # PostgreSQL для хранения телеметрии с бионических протезов (с поддержкой репликации для Debezium)
    container_name: telemetry_db
    image: postgres:14
    environment:
      POSTGRES_DB: telemetry_db  # Имя базы данных
      POSTGRES_USER: telemetry_user  # Пользователь БД
      POSTGRES_PASSWORD: telemetry_password  # Пароль пользователя
    command:
      - "postgres"
      - "-c"
      - "wal_level=logical"  # Включаем логическую репликацию для Debezium
#    volumes:
#        - ./postgres-telemetry-data:/var/lib/postgresql/data  # Персистентное хранилище данных
    ports:
      - "5445:5432"  # Порт для подключения к Telemetry DB
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U telemetry_user -d telemetry_db"]  # Проверка готовности PostgreSQL
      interval: 5s
      timeout: 3s
      retries: 5
  olap_db:
    # ClickHouse для OLAP-аналитики (данные импортируются из CRM и Telemetry БД)
    container_name: olap_db
    image: clickhouse/clickhouse-server:latest
    environment:
      CLICKHOUSE_DB: default  # База данных по умолчанию
      CLICKHOUSE_USER: default  # Пользователь по умолчанию
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1  # Разрешить управление доступом
      CLICKHOUSE_PASSWORD: "clickhouse_password"  # Пароль для разработки
    ports:
      - "8123:8123"  # HTTP-интерфейс для clickhouse-connect
      - "8443:8443"
      - "9431:9000"  # Native-протокол
    volumes:
#      - ./clickhouse-data:/var/lib/clickhouse  # Персистентное хранилище данных
      - ./clickhouse_config/users.d:/etc/clickhouse-server/users.d  # Конфигурация пользователей
    healthcheck:
      test: ["CMD-SHELL", "clickhouse-client --password clickhouse_password --query 'SELECT 1'"]
      interval: 1s
      timeout: 3s
      retries: 30
    depends_on:
      debezium:
        condition: service_healthy  # Ждём готовности Debezium
  zookeeper:
    # Zookeeper для координации Kafka
    container_name: zookeeper
    image: confluentinc/cp-zookeeper:7.5.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181  # Порт для клиентов Zookeeper
      ZOOKEEPER_TICK_TIME: 2000  # Базовый интервал времени в миллисекундах
    ports:
      - "2181:2181"  # Порт Zookeeper
  
  kafka:
    # Kafka-брокер для потоковой передачи данных
    container_name: kafka
    image: confluentinc/cp-kafka:7.5.0
    depends_on:
      - zookeeper  # Kafka зависит от Zookeeper
    environment:
      KAFKA_BROKER_ID: 1  # Уникальный ID брокера
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181  # Подключение к Zookeeper
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092  # Адреса для клиентов
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT  # Протоколы безопасности
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT  # Listener для межброкерного общения
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1  # Фактор репликации для топика оффсетов
    ports:
      - "29092:29092"  # Порт Kafka для внешних подключений
    healthcheck:
      test: ["CMD-SHELL", "kafka-broker-api-versions --bootstrap-server localhost:9092 || exit 1"]  # Проверка готовности Kafka
      interval: 5s
      timeout: 10s
      retries: 10
      start_period: 30s
  
  kafdrop:
    # Kafdrop - веб-интерфейс для просмотра Kafka-топиков
    container_name: kafdrop
    image: obsidiandynamics/kafdrop:latest
    depends_on:
      - kafka  # Kafdrop зависит от Kafka
    environment:
      KAFKA_BROKERCONNECT: kafka:9092  # Подключение к Kafka-брокеру
      JVM_OPTS: "-Xms32M -Xmx64M"  # Настройки JVM для экономии памяти
    ports:
      - "9100:9000"  # Веб-интерфейс Kafdrop
  
  debezium:
    # Debezium Kafka Connect для CDC (Change Data Capture) из PostgreSQL
    # Используем кастомный образ с автоматической инициализацией коннекторов
    container_name: debezium
    build:
      context: ./debezium  # Папка с Dockerfile и скриптом инициализации
      dockerfile: Dockerfile  # Dockerfile для сборки кастомного образа
    depends_on:
      kafka:
        condition: service_healthy  # Ждём готовности Kafka
      crm_db:
        condition: service_healthy  # Ждём готовности CRM DB
      telemetry_db:
        condition: service_healthy  # Ждём готовности Telemetry DB
    environment:
      BOOTSTRAP_SERVERS: kafka:9092  # Адрес Kafka-брокера
      GROUP_ID: debezium-group  # ID группы для Kafka Connect
      CONFIG_STORAGE_TOPIC: debezium_configs  # Топик для хранения конфигураций
      OFFSET_STORAGE_TOPIC: debezium_offsets  # Топик для хранения оффсетов
      STATUS_STORAGE_TOPIC: debezium_statuses  # Топик для хранения статусов
      CONNECT_KEY_CONVERTER: org.apache.kafka.connect.json.JsonConverter  # Конвертер ключей
      CONNECT_VALUE_CONVERTER: org.apache.kafka.connect.json.JsonConverter  # Конвертер значений
      CONNECT_KEY_CONVERTER_SCHEMAS_ENABLE: "false"  # Отключаем схемы для ключей
      CONNECT_VALUE_CONVERTER_SCHEMAS_ENABLE: "false"  # Отключаем схемы для значений
    ports:
      - "8083:8083"  # REST API Kafka Connect
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8083/ || exit 1"]  # Проверка готовности Debezium
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 30s
  
  minio:
    container_name: minio
    image: minio/minio
    ports:
      - "9000:9000"
      - "9001:9001"
#    volumes:
#      - minio_storage:/data
    environment:
      MINIO_ROOT_USER: minio_user
      MINIO_ROOT_PASSWORD: minio_password
    command: server --console-address ":9001" /data

#volumes:
#  minio_storage: {}